<template>
  <div>
    <p>{{ financialMonitoringStore.pageParams.title }}</p>
    <span v-if="isIgnoredInCalculation"><el-icon size="small"><Hide /></el-icon></span>
    <span v-if="isFavorite"><el-icon size="small"><CollectionTag /></el-icon></span>
    <p>Сумма</p>
    <el-input style="width: 250px" v-model="amount" placeholder="Введите сумму" :formatter="(value) => `${value}`.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1')">
    </el-input>

    <p>Категория</p>
    <div class="picker-category">
      <el-autocomplete
        v-model="selectedCategory"
        :fetch-suggestions="querySearch"
        :trigger-on-focus="false"
        placeholder="Категория"
        clearable>
      </el-autocomplete>

      <el-button @click="isCategoryListDialogVisible = true"><el-icon><ArrowRight /></el-icon></el-button>
    </div>
    <div class="error-message" v-if="isSubmitAttempted && errorMessage">Выбранная категория не найдена. Пожалуйста, выберите другую категорию</div>

    <el-dialog v-model="isCategoryListDialogVisible" title="Выберите категорию" width="500" center align-center>
      <span>
        <financial-monitoring-category-list
        @category-selected="onCategorySelected">
        </financial-monitoring-category-list>
      </span>
    </el-dialog>

    <p>Дата</p>
    <el-date-picker style="width: 250px" v-model="datePicker" type="datetime" placeholder="Выберите дату и время" format="YYYY/MM/DD HH:mm" value-format="YYYY/MM/DD HH:mm" time-format="HH:mm"/>

    <p v-if="isDescription">
      <el-input style="width: 250px" v-model="description" :autosize="{ minRows: 2, maxRows: 4 }" type="textarea" placeholder="Примечание" />
    </p>

    <p>
      <el-button @click="addDescription()"><el-icon><EditPen /></el-icon></el-button>
      <el-button><el-icon><PictureFilled /></el-icon></el-button>
      <el-button @click="editIsFavorite()"><el-icon><CollectionTag /></el-icon></el-button>
      <el-button v-if="financialMonitoringStore.pageParams.showDeleteButton" @click="deleteExpense(this.financialMonitoringStore.pageParams.id)"><el-icon><Delete /></el-icon></el-button>
    </p>

    <p>
      Не учитывать в общей сумме
      <el-switch v-model="isIgnoredInCalculation" />
    </p>

    <div v-if="financialMonitoringStore.pageParams.title == 'Добавление раcхода'">
      <p>
        <el-button @click="backToHome()">Назад</el-button>
        <el-button type="primary" @click="addExpense(amount, selectedCategory, datePicker)" :disabled="checkFieldsAddExpense()">Добавить</el-button>
      </p>
    </div>

    <div v-if="financialMonitoringStore.pageParams.title == 'Редактирование раcхода'">
      <p>
        <el-button @click="backToHome()">Назад</el-button>
        <el-button type="primary" @click="editExpense()" :disabled="checkFieldsAddExpense()">Сохранить</el-button>
      </p>
    </div>
  </div>
</template> 

<script>
import { useFinancialMonitoringStore } from '@/stores/FinancialMonitoringStore';
import { ElMessage, ElMessageBox } from 'element-plus';
import FinancialMonitoringCategoryList from './FinancialMonitoringCategoryList.vue';

export default {
  name: "financial-monitoring-add-note",
  components: {
    FinancialMonitoringCategoryList,
  },
  setup() {
    const financialMonitoringStore = useFinancialMonitoringStore();
    return { financialMonitoringStore };
  },
  created() {
    let expense = this.getExpense(this.financialMonitoringStore.pageParams.id);

    if (expense) {
      this.amount = expense.amount;
      this.selectedCategory = expense.category;
      this.datePicker = expense.date;
      this.description = expense.description;
      this.isIgnoredInCalculation = expense.isIgnoredInCalculation;
      this.isFavorite = expense.isFavorite;
    } else {
      this.setCurrentDate();
    }
  },
  mounted() {
    this.categoryListForSuggestion = this.loadAllCategoryList();
  },
  watch: {
  selectedCategory(newValue) {
    if (newValue.length === 0) {
      this.errorMessage = false;
      this.isSubmitAttempted = false;
    }
  }
},
  data() {
    return {
      amount: null,
      selectedCategory: '',
      datePicker: '',
      isDescription: false,
      description: '',
      isIgnoredInCalculation: false,
      isFavorite: false,
      isCategoryListDialogVisible: false,
      categoryListForSuggestion: [],
      errorMessage: false,
      isSubmitAttempted: false,
    };
  },
  methods: {
    backToHome: function () {
      if (this.financialMonitoringStore.pageParams.returnToInfoNote) {
        this.financialMonitoringStore.setPage('infoNote', {
          id: this.financialMonitoringStore.pageParams.id,
          typeSortExpenses: this.financialMonitoringStore.pageParams.typeSortExpenses,
          typeFilterExpenses: this.financialMonitoringStore.pageParams.typeFilterExpenses,
          typeGroupExpenses: this.financialMonitoringStore.pageParams.typeGroupExpenses,
          activeTab: this.financialMonitoringStore.pageParams.activeTab,
          tabs: this.financialMonitoringStore.pageParams.tabs,
          selectedFilterCategory: this.financialMonitoringStore.pageParams.selectedFilterCategory,
        });
      } else {
        this.financialMonitoringStore.setPage('expenses', {
          selectedTypeSortExpenses: this.financialMonitoringStore.pageParams.typeSortExpenses,
          selectedTypeFilterExpenses: this.financialMonitoringStore.pageParams.typeFilterExpenses,
          selectedTypeGroupExpenses: this.financialMonitoringStore.pageParams.typeGroupExpenses,
          selectedActiveTab: this.financialMonitoringStore.pageParams.activeTab,
          currentTabs: this.financialMonitoringStore.pageParams.tabs,
          selectedFilterCategory: this.financialMonitoringStore.pageParams.selectedFilterCategory,
        });
      }
    },
    addExpense: function (amount, selectedCategory, datePicker) {
    this.isSubmitAttempted = true;

    const allCategories = this.loadAllCategoryList();
    const isValidCategory = allCategories.find(item => item.value.toLowerCase() === selectedCategory.toLowerCase());

    if (isValidCategory) {
      const formattedCategory = selectedCategory[0].toUpperCase() + selectedCategory.slice(1);

      this.financialMonitoringStore.addNote({
        id: this.financialMonitoringStore.expenses.length + 1,
        idCategory: isValidCategory.id,
        amount: parseFloat(amount),
        category: formattedCategory,
        date: datePicker,
        description: this.description,
        isIgnoredInCalculation: this.isIgnoredInCalculation,
        isFavorite: this.isFavorite,
      });

    this.financialMonitoringStore.setPage('expenses', {
      selectedDate: datePicker,
      currentTabs: this.financialMonitoringStore.pageParams.tabs,
      });

      this.errorMessage = false;
      } else {
        this.errorMessage = true;
      }
    },
    getExpense: function (id) {
      return this.financialMonitoringStore.expenses.find((item) => item.id == id);
    },
    editExpense: function () {
      this.isSubmitAttempted = true;
      let expense = this.getExpense(this.financialMonitoringStore.pageParams.id);

      const allCategories = this.loadAllCategoryList();
      const isValidCategory = allCategories.find(item => item.value.toLowerCase() === this.selectedCategory.toLowerCase());

      if (isValidCategory) {
        const formattedCategory = this.selectedCategory[0].toUpperCase() + this.selectedCategory.slice(1);

        expense.amount = parseFloat(this.amount);
        expense.category = formattedCategory;
        expense.date = this.datePicker;
        expense.description = this.description;
        expense.isIgnoredInCalculation = this.isIgnoredInCalculation;
        expense.isFavorite = this.isFavorite;

        this.financialMonitoringStore.setPage('expenses', {
        selectedTypeSortExpenses: this.financialMonitoringStore.pageParams.typeSortExpenses,
        selectedTypeFilterExpenses: this.financialMonitoringStore.pageParams.typeFilterExpenses,
        selectedTypeGroupExpenses: this.financialMonitoringStore.pageParams.typeGroupExpenses,
        selectedActiveTab: this.financialMonitoringStore.pageParams.activeTab,
        currentTabs: this.financialMonitoringStore.pageParams.tabs,
        selectedFilterCategory: this.financialMonitoringStore.pageParams.selectedFilterCategory,
      })

        this.errorMessage = false;
      } else {
        this.errorMessage = true;
      }
    },
    checkFieldsAddExpense: function () {
      return this.selectedCategory == 0 || this.amount == 0 || this.datePicker == 0 ? true : false;
    },
    addDescription: function () {
      this.isDescription = !this.isDescription;
    },
    editIsFavorite: function () {
      this.isFavorite = !this.isFavorite;
    },
    deleteExpense: function (id) {
      ElMessageBox.confirm(
      'Удалить запись ?',
      'Подтвердите действие',
      {
        confirmButtonText: 'Удалить',
        cancelButtonText: 'Отменить',
        type: 'warning',
        center: true,
        draggable: true,
      }
    )
      .then(() => {
        ElMessage({
          type: 'success',
          message: 'Запись удалена',
        })
        this.financialMonitoringStore.deleteExpense(id);
        this.financialMonitoringStore.setPage('expenses', {
          selectedTypeSortExpenses: this.financialMonitoringStore.pageParams.typeSortExpenses,
          selectedTypeFilterExpenses: this.financialMonitoringStore.pageParams.typeFilterExpenses,
          selectedTypeGroupExpenses: this.financialMonitoringStore.pageParams.typeGroupExpenses,
          selectedActiveTab: this.financialMonitoringStore.pageParams.activeTab,
          currentTabs: this.financialMonitoringStore.pageParams.tabs,
          selectedFilterCategory: this.financialMonitoringStore.pageParams.selectedFilterCategory,
          removeEmptyTabs: true,
        });
      })
      .catch(() => {
        ElMessage({
          type: 'info',
          message: 'Удаление отменено',
        })
      })
    },
    onCategorySelected: function (category) {
      this.selectedCategory = category.label;
      this.isCategoryListDialogVisible = false;
    },
    querySearch: function (queryString, callback) {
      const results = queryString ? this.categoryListForSuggestion.filter(this.createFilter(queryString)) : this.categoryListForSuggestion;
      callback(results);
    },
    createFilter: function (queryString) {
      return (labelCategory) => {
        return (labelCategory.value.toLowerCase().indexOf(queryString.toLowerCase()) === 0);
      };
    },
    loadAllCategoryList: function () {
      const store = this.financialMonitoringStore;
      const categories = store.categories;

      const extractCategories = (categories) => {
        let result = [];
        categories.forEach(category => {
          result.push({
            value: store.getCategoryLabelById(category.id),
            id: category.id,
          });

          if (category.children && category.children.length > 0) {
            result = result.concat(extractCategories(category.children));
          }
        });
        return result;
      };

      return extractCategories(categories);
    },
    setCurrentDate: function () {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const hours = String(today.getHours()).padStart(2, '0');
      const minutes = String(today.getMinutes()).padStart(2, '0');

      this.datePicker = `${year}/${month}/${day} ${hours}:${minutes}`;
    },
  },
};
</script>
<style lang="scss">

.picker-category {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 10px;
  width: 250px;

  .el-autocomplete {
    width: 100%;
  }

  .el-button {
    width: 32px;
  }
}

.error-message {
  max-width: 250px;
  color: red;
  margin-top: 10px;
  font-size: 15px;
}
</style>

